//-
  ztncui - ZeroTier network controller UI
  Copyright (C) 2017-2021  TsingWin (http://www.tsingwin.net)
  Licensed under GPLv3 - see LICENSE for details.

extends network_layout

//- Don't display that title
block title

//- Replace the network title with editable one
block network_title
  - const networkNameTextEn = 'Network Name'
  - const networkNameTextZh = '网络名称'
  
  block network_title
  h2
    if t.lang && t.lang.toggle === '中'
      = networkNameTextZh
    else
      = networkNameTextEn
    a#change-name(href='#')
      span#name= network.name
      i.glyphicon.glyphicon-pencil(style='font-size: 20px;')
    input#name-input.form-control(type='text' style='width: 200px; display: none;')
    |  (#{network.nwid}):
  script.
    $(function() {
      var nwurl = '/controller/network/#{network.nwid}';
      var name = !{JSON.stringify(network.name)};

      function toggleNameEditor(show) {
        $('#change-name').css('display', !show ? '' : 'none');
        $('#name-input').css('display', show ? 'inline-block' : 'none');
      }

      function submit() {
        var newName = $('#name-input').val();
        if (newName != name) {
          name = newName;
          $.post(nwurl + '/name', {'name': name})
            .done(function () {
              $('#name').text(newName);
            });
        }
        toggleNameEditor(false);
      }

      $('#change-name').on('click', function() {
        toggleNameEditor(true);
        $('#name-input').val(name);
        $('#name-input').focus();
      });
      $('#name-input').on('focusout', submit);
      $('#name-input').keypress(function (e) {
        if (e.which == 13) submit();
      });
    });

block net_content
  - const nwurl = '/controller/network/' + network.nwid;

  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/private') role='button')
    = network.private ? t.networks.private : t.networks.public
  - const easySetupTextEn = 'Easy Setup'
  - const easySetupTextZh = '简单设置'
  - const routesTextEn = 'Routes'
  - const routesTextZh = '路由'
  - const ipPoolsTextEn = 'IP Assignment Pools'
  - const ipPoolsTextZh = '地址分配池'
  - const ipv4ModeTextEn = 'IPv4 Assign Mode'
  - const ipv4ModeTextZh = 'IPv4分配模式'
  - const ipv6ModeTextEn = 'IPv6 Assign Mode'
  - const ipv6ModeTextZh = 'IPv6分配模式'
  - const dnsTextEn = 'DNS'
  - const dnsTextZh = 'DNS'
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/easy') role='button')
    if t.networks && t.networks.easy_setup
      = t.networks.easy_setup
    else
      = t.lang && t.lang.toggle === '中' ? easySetupTextZh : easySetupTextEn
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/routes') role='button')
    if t.networks && t.networks.routes
      = t.networks.routes
    else
      = t.lang && t.lang.toggle === '中' ? routesTextZh : routesTextEn
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/ipAssignmentPools') role='button')
    if t.networks && t.networks.assignment_pools
      = t.networks.assignment_pools
    else
      = t.lang && t.lang.toggle === '中' ? ipPoolsTextZh : ipPoolsTextEn
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/v4AssignMode') role='button')
    if t.networks && t.networks.ipv4_assign_mode
      = t.networks.ipv4_assign_mode
    else
      = t.lang && t.lang.toggle === '中' ? ipv4ModeTextZh : ipv4ModeTextEn
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/v6AssignMode') role='button')
    if t.networks && t.networks.ipv6_assign_mode
      = t.networks.ipv6_assign_mode
    else
      = t.lang && t.lang.toggle === '中' ? ipv6ModeTextZh : ipv6ModeTextEn
  
  a.btn.btn-primary(style="margin: 5px" href=(nwurl + '/dns') role='button')
    if t.networks && t.networks.dns
      = t.networks.dns
    else
      = t.lang && t.lang.toggle === '中' ? dnsTextZh : dnsTextEn

  if (members !== undefined)
    script.
      $(function() {
        const url = "#{nwurl}/members";
        $('.authCheck').on('click', function() {
          $.post(url, {'id': this.value, 'auth': this.checked});
        });
        $('.bridgeCheck').on('click', function() {
          $.post(url, {'id': this.value, 'activeBridge': this.checked});
        });
        $('.text').on('change', function() {
          $.post(url, {'id': this.name, 'name': this.value});
        });
      });
    h3#members Members (#{members.length})
    form(method='POST' action='')
      table.table.table-responsive.table-striped.table-hover
        tr
          td(width='3%')
            = ''
          td(width='20%')
            = t.networks.member_table.name
          td(width='10%')
            = t.networks.member_table.id
          td(width='10%')
            = t.networks.member_table.authorized
          td(width='10%')
            = t.networks.member_table.active_bridge
          td(width='17%')
            = t.networks.member_table.ip_assignment
          td(width='17%')
            = t.networks.member_table.peer_status
          td(width='13%')
            = ''
        each member in members
          - const peer = member.peer;
          tr
            - const url = nwurl + '/member/' + member.id
            td
              a(href=url + '/delete')
                i.glyphicon.glyphicon-trash
            td
              input.form-control.text(type='text' name=member.id value=member.name)
            td
              a(href=url) #{member.id}
            td
              input.authCheck(type='checkbox' value=member.id checked=(member.authorized? true : false))
            td
              input.bridgeCheck(type='checkbox' value=member.id checked=(member.activeBridge? true : false))
            td
              each ipAssignment in member.ipAssignments
                a(href=nwurl + '/member/' + member.id + '/ipAssignments')
                  each digit in ipAssignment
                    = digit
                  = ' '
              else
                a(href=nwurl + '/member/' + member.id + '/ipAssignments')
                  = t.networks.ip_assignment
            td
              if (peer && peer.latency != -1 && peer.versionMajor != -1)
                if (peer.latency != -1)
                  span(style='color: green;')
                    | Online (v#{peer.version})
                else
                  span(style='color: orange;')
                    | Relay (v#{peer.version})
              else if (member.id == zt_address)
                span(style='color: green;') Controller
              else
                span(style='color: red;') Offline
            td
              if (peer)
                each path in peer.paths
                  if (path.preferred == true)
                    - const [ip, port] = path.address.split('/');
                    = ip
                    span(style='color: gray;') /#{port}
                    = ' '
                    if (peer.latency != -1)
                      br
                      | (#{peer.latency} ms)
                    - break
        else
          .alert.alert-info
            strong= t.networks.no_members

  - const refreshTextEn = 'Refresh'
  - const refreshTextZh = '刷新'
  
  a.btn.btn-default(href='' name='refresh' role='button')
    if t.lang && t.lang.toggle === '中'
      = refreshTextZh
    else
      = refreshTextEn

  - const authTokensText = t.networks.network_fields && t.networks.network_fields.authTokens ? t.networks.network_fields.authTokens : '认证令牌'
  - const authorizationEndpointText = t.networks.network_fields && t.networks.network_fields.authorizationEndpoint ? t.networks.network_fields.authorizationEndpoint : '授权端点'
  - const capabilitiesText = t.networks.network_fields && t.networks.network_fields.capabilities ? t.networks.network_fields.capabilities : '能力'
  - const clientIdText = t.networks.network_fields && t.networks.network_fields.clientId ? t.networks.network_fields.clientId : '客户端ID'
  - const creationTimeText = t.networks.network_fields && t.networks.network_fields.creationTime ? t.networks.network_fields.creationTime : '创建时间'
  - const dnsText = t.networks.network_fields && t.networks.network_fields.dns ? t.networks.network_fields.dns : 'DNS配置'
  - const enableBroadcastText = t.networks.network_fields && t.networks.network_fields.enableBroadcast ? t.networks.network_fields.enableBroadcast : '启用广播'
  - const idText = t.networks.network_fields && t.networks.network_fields.id ? t.networks.network_fields.id : '网络ID'
  - const ipAssignmentPoolsText = t.networks.network_fields && t.networks.network_fields.ipAssignmentPools ? t.networks.network_fields.ipAssignmentPools : 'IP分配池'
  - const mtuText = t.networks.network_fields && t.networks.network_fields.mtu ? t.networks.network_fields.mtu : 'MTU'
  - const multicastLimitText = t.networks.network_fields && t.networks.network_fields.multicastLimit ? t.networks.network_fields.multicastLimit : '多播限制'
  - const nameText = t.networks.network_fields && t.networks.network_fields.name ? t.networks.network_fields.name : '网络名称'
  - const nwidText = t.networks.network_fields && t.networks.network_fields.nwid ? t.networks.network_fields.nwid : '网络ID'
  - const objtypeText = t.networks.network_fields && t.networks.network_fields.objtype ? t.networks.network_fields.objtype : '对象类型'
  - const privateText = t.networks.network_fields && t.networks.network_fields.private ? t.networks.network_fields.private : '私有网络'
  - const remoteTraceLevelText = t.networks.network_fields && t.networks.network_fields.remoteTraceLevel ? t.networks.network_fields.remoteTraceLevel : '远程跟踪级别'
  - const remoteTraceTargetText = t.networks.network_fields && t.networks.network_fields.remoteTraceTarget ? t.networks.network_fields.remoteTraceTarget : '远程跟踪目标'
  - const revisionText = t.networks.network_fields && t.networks.network_fields.revision ? t.networks.network_fields.revision : '修订版本'
  - const routesText = t.networks.network_fields && t.networks.network_fields.routes ? t.networks.network_fields.routes : '路由'
  - const rulesText = t.networks.network_fields && t.networks.network_fields.rules ? t.networks.network_fields.rules : '规则'
  - const rulesSourceText = t.networks.network_fields && t.networks.network_fields.rulesSource ? t.networks.network_fields.rulesSource : '规则源'
  - const ssoEnabledText = t.networks.network_fields && t.networks.network_fields.ssoEnabled ? t.networks.network_fields.ssoEnabled : 'SSO启用'
  - const tagsText = t.networks.network_fields && t.networks.network_fields.tags ? t.networks.network_fields.tags : '标签'
  - const v4AssignModeText = t.networks.network_fields && t.networks.network_fields.v4AssignMode ? t.networks.network_fields.v4AssignMode : 'IPv4分配模式'
  - const v6AssignModeText = t.networks.network_fields && t.networks.network_fields.v6AssignMode ? t.networks.network_fields.v6AssignMode : 'IPv6分配模式'
  
  h3#detail Detail
  each value, key in network
    .row(style='margin: 5px 0;')
      .col-sm-2
        a(href= network.nwid + '/' + key)
          if key === 'authTokens'
            = authTokensText
          else if key === 'authorizationEndpoint'
            = authorizationEndpointText
          else if key === 'capabilities'
            = capabilitiesText
          else if key === 'clientId'
            = clientIdText
          else if key === 'creationTime'
            = creationTimeText
          else if key === 'dns'
            = dnsText
          else if key === 'enableBroadcast'
            = enableBroadcastText
          else if key === 'id'
            = idText
          else if key === 'ipAssignmentPools'
            = ipAssignmentPoolsText
          else if key === 'mtu'
            = mtuText
          else if key === 'multicastLimit'
            = multicastLimitText
          else if key === 'name'
            = nameText
          else if key === 'nwid'
            = nwidText
          else if key === 'objtype'
            = objtypeText
          else if key === 'private'
            = privateText
          else if key === 'remoteTraceLevel'
            = remoteTraceLevelText
          else if key === 'remoteTraceTarget'
            = remoteTraceTargetText
          else if key === 'revision'
            = revisionText
          else if key === 'routes'
            = routesText
          else if key === 'rules'
            = rulesText
          else if key === 'rulesSource'
            = rulesSourceText
          else if key === 'ssoEnabled'
            = ssoEnabledText
          else if key === 'tags'
            = tagsText
          else if key === 'v4AssignMode'
            = v4AssignModeText
          else if key === 'v6AssignMode'
            = v6AssignModeText
          else
            = key
          | :
      .col-sm-10
        +json_value(value)

  - const backToNetworksTextEn = 'Back to Networks'
  - const backToNetworksTextZh = '返回网络列表'
  
  a.btn.btn-default(href='/controller/networks' name='networks' role='button' style='margin-top: 10px;')
    if t.lang && t.lang.toggle === '中'
      = backToNetworksTextZh
    else
      = backToNetworksTextEn
